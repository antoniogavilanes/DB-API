<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi API Tareas</title>
    <link rel="stylesheet" href="/css/estilos.css">
    <style>
       
    </style>
</head>

<body>
    <h1>API Administrador de Tareas</h1>
    <div class="botonNuevaTarea">
        <button id="btnMostrarFormulario"><span>&#43;</span> Añadir Nueva Tarea</button>
    </div>

    <div id="formularioNuevaTarea" style="display: none;">
        <h1>Crear Nueva Tarea</h1>
        <form id="formCrearTarea">
            <label for="nombre">Título:</label>
            <input type="text" id="nombre" name="nombre" required>
            <label for="descripcion">Descripción:</label>
            <input id="descripcion" name="descripcion" required>
            <button type="submit">Agregar Tarea</button>
            <button type="button" id="btnCancelar">Cancelar</button>
        </form>
    </div>

    <div id="formularioEditarTarea" style="display: none;">
        <h1>Editar Tarea</h1>
        <form id="formEditarTarea">
            <label for="nombreEditar">Título:</label>
            <input type="text" id="nombreEditar" name="nombreEditar" required>
            <label for="descripcionEditar">Descripción:</label>
            <input id="descripcionEditar" name="descripcionEditar" required>
            <button type="submit">Guardar Cambios</button>
            <button type="button" id="btnCancelarEdicion">Cancelar</button>
        </form>
    </div>

    <div id="contenedorTarjetas" class="contenedor-tarjetas">
        <!-- Aquí se mostrarán las tarjetas de las tareas -->
    </div>

    <script>
        function mostrarFormularioNuevaTarea() {
            document.getElementById('formularioNuevaTarea').style.display = 'block';
        }

        function ocultarFormularioNuevaTarea() {
            document.getElementById('formularioNuevaTarea').style.display = 'none';
        }

        function mostrarFormularioEditarTarea(id, nombre, descripcion) {
            document.getElementById('formularioEditarTarea').style.display = 'block';
            document.getElementById('nombreEditar').value = nombre;
            document.getElementById('descripcionEditar').value = descripcion;

            document.getElementById('formEditarTarea').setAttribute('data-id', id);
        }

        function ocultarFormularioEditarTarea() {
            document.getElementById('formularioEditarTarea').style.display = 'none';
        }

        document.getElementById('btnMostrarFormulario').addEventListener('click', mostrarFormularioNuevaTarea);

        document.getElementById('btnCancelar').addEventListener('click', ocultarFormularioNuevaTarea);

        document.getElementById('btnCancelarEdicion').addEventListener('click', ocultarFormularioEditarTarea);

        async function mostrarTareas() {
            try {
                const response = await fetch('/tareas');
                if (!response.ok) {
                    throw new Error('Error al obtener las tareas');
                }
                const tareas = await response.json();
                const contenedorTarjetas = document.getElementById('contenedorTarjetas');
                contenedorTarjetas.innerHTML = '';
                tareas.forEach(tarea => {
                    const tarjeta = `
                        <div class="tarjeta">
                            <h3 style="text-align: center;">${tarea.nombre}</h3>
                            <div class="descpicionTarjeta">
                            <p style="text-align: justify;">${tarea.descripcion}</p>
                            </div>
                            <div class="acciones">
                                <button onclick="mostrarFormularioEditarTarea('${tarea._id}', '${tarea.nombre}', '${tarea.descripcion}')">Editar</button>
                                <button onclick="eliminarTarea('${tarea._id}')">Eliminar</button>
                            </div>
                        </div>
                    `;
                    contenedorTarjetas.innerHTML += tarjeta;
                });
            } catch (error) {
                console.error(error);
                alert('Error al obtener las tareas');
            }
        }

        async function eliminarTarea(id) {
            try {
                const response = await fetch(`/tareas/${id}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    throw new Error('Error al eliminar la tarea');
                }
                mostrarTareas();
            } catch (error) {
                console.error(error);
                alert('Error al eliminar la tarea');
            }
        }

        document.getElementById('formCrearTarea').addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(event.target);
            const nombre = formData.get('nombre');
            const descripcion = formData.get('descripcion');

            try {
                const response = await fetch('/tareas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nombre, descripcion })
                });
                if (!response.ok) {
                    throw new Error('No se pudo agregar la tarea');
                }
                alert('Tarea agregada correctamente');
                window.location.href = '/';
            } catch (error) {
                console.error(error);
                alert('Error al agregar la tarea');
            }
        });

        document.getElementById('formEditarTarea').addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(event.target);
            const nombre = formData.get('nombreEditar');
            const descripcion = formData.get('descripcionEditar');
            const id = event.target.getAttribute('data-id');

            try {
                const response = await fetch(`/tareas/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nombre, descripcion })
                });
                if (!response.ok) {
                    throw new Error('No se pudo actualizar la tarea');
                }
                alert('Tarea actualizada correctamente');
                ocultarFormularioEditarTarea();
                mostrarTareas();
            } catch (error) {
                console.error(error);
                alert('Error al actualizar la tarea');
            }
        });

        mostrarTareas();
    </script>
</body>

</html>
